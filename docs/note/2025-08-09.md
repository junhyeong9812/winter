# 25챕터 세션 관리 구현 과정

## 📖 개요
Winter Framework에 HTTP 세션 관리 기능을 추가하는 25챕터 구현 과정을 정리한 문서입니다.

## 🎯 구현 목표
- HTTP 세션 생성 및 관리
- 쿠키 기반 세션 ID 관리
- 세션 기반 상태 유지 (로그인, 쇼핑카트 등)
- 세션 생명주기 관리 (생성, 갱신, 만료, 무효화)

## 🔧 구현된 주요 컴포넌트

### 1. 세션 관리 핵심 클래스
- **`HttpSession`** - 세션 인터페이스
- **`StandardHttpSession`** - 세션 구현체
- **`SessionManager`** - 세션 생명주기 중앙 관리
- **`SessionConfig`** - 세션 설정 관리
- **`Cookie`** - HTTP 쿠키 관리

### 2. 기존 클래스 확장
- **`HttpRequest`** - 세션 접근 메서드 추가
- **`HttpResponse`** - 쿠키 설정 기능 추가
- **`Dispatcher`** - 세션 생명주기 통합

### 3. 테스트 컴포넌트
- **`SessionController`** - 세션 기능 테스트용 컨트롤러
- **`SessionHtmlGenerator`** - 간단한 HTML 생성 유틸리티

## 📝 구현 단계별 과정

### Step 1: 세션 인터페이스 및 구현체 작성
```java
// HttpSession 인터페이스 정의
public interface HttpSession {
    String getId();
    Object getAttribute(String name);
    void setAttribute(String name, Object value);
    void invalidate();
    // ... 기타 메서드들
}

// StandardHttpSession 구현체 작성
public class StandardHttpSession implements HttpSession {
    // 메모리 기반 세션 구현
    // 생성시간, 마지막 접근시간, 타임아웃 관리
}
```

### Step 2: 세션 매니저 구현
```java
public class SessionManager {
    // 세션 생성, 조회, 삭제
    // 백그라운드 정리 작업
    // 통계 정보 관리
}
```

### Step 3: 쿠키 관리 기능 추가
```java
public class Cookie {
    // RFC 6265 표준 준수
    // 보안 설정 (HttpOnly, Secure, SameSite)
    // HTTP 헤더 문자열 생성
}
```

### Step 4: HTTP 요청/응답 클래스 확장
```java
// HttpRequest에 세션 관련 메서드 추가
public HttpSession getSession();
public Cookie getCookie(String name);

// HttpResponse에 쿠키 관련 메서드 추가
public void addCookie(Cookie cookie);
public void setSessionCookie(String sessionId);
```

### Step 5: Dispatcher 통합
```java
// 세션 생명주기를 요청 처리 과정에 통합
private void handleSession(HttpRequest request, HttpResponse response) {
    // 세션 ID 추출
    // 기존 세션 조회 또는 새 세션 생성
    // 세션 쿠키 설정
}
```

### Step 6: 테스트 컨트롤러 작성
```java
@Controller
public class SessionController {
    @RequestMapping("/session")
    public ModelAndView sessionHome(HttpRequest request);
    
    @RequestMapping("/session/login")
    public ModelAndView login(@RequestParam("username") String username);
    
    // ... 기타 세션 테스트 메서드들
}
```

## 🧪 테스트 시나리오

### 1. 기본 세션 관리
- 새 세션 생성
- 기존 세션 재사용
- 세션 정보 조회

### 2. 로그인/로그아웃 시뮬레이션
- 사용자 인증 및 세션 저장
- 세션 기반 사용자 정보 유지
- 로그아웃 시 세션 무효화

### 3. 쇼핑카트 기능
- 세션 기반 장바구니 관리
- 상품 추가/제거
- 장바구니 상태 유지

### 4. 세션 설정 관리
- 타임아웃 변경
- 세션 속성 CRUD

## 🔑 핵심 특징

### 보안
- 보안 강화된 세션 ID 생성 (128bit 엔트로피)
- HttpOnly, Secure, SameSite 쿠키 설정
- 세션 고정 공격 방지

### 성능
- 메모리 기반 고속 세션 저장소
- 백그라운드 만료 세션 정리
- ConcurrentHashMap을 통한 동시성 지원

### 확장성
- 인터페이스 기반 설계로 확장 가능
- 분산 세션 스토어 연동 가능
- 다양한 세션 저장 방식 지원 가능

## 📊 통계 및 모니터링
- 생성된 세션 수
- 만료된 세션 수
- 무효화된 세션 수
- 현재 활성 세션 수

## 🚀 실행 방법
```bash
# WinterMain 실행
java winter.WinterMain

# 세션 테스트 확인
# 콘솔에서 세션 생성, 속성 설정, 로그인 등의 과정 확인
```

## 📈 향후 확장 계획
- Redis 연동 분산 세션
- 세션 클러스터링
- 세션 영속화
- 세션 복제 및 백업
- 웹 UI 세션 모니터링 도구

## 🎉 완성도
✅ 기본 세션 관리  
✅ 쿠키 기반 세션 ID 관리  
✅ 세션 생명주기 관리  
✅ 보안 설정  
✅ 테스트 시나리오  
✅ 통계 및 모니터링

25챕터 세션 관리 기능이 성공적으로 구현되었습니다!

# 25챕터 세션 구현 중 발생한 문제들과 해결 방법

## 🚨 문제 해결 가이드

### 문제 1: Cookie 클래스에 `toHeaderString()` 메서드 누락
**증상:**
```
java.lang.NoSuchMethodError: winter.http.Cookie.toHeaderString()
```

**원인:**
- HttpResponse에서 `cookie.toHeaderString()` 호출하는데 메서드가 존재하지 않음
- Cookie 클래스가 HTTP Set-Cookie 헤더 생성 기능 누락

**해결 방법:**
```java
// Cookie.java에 추가
public String toHeaderString() {
    StringBuilder header = new StringBuilder();
    header.append(name).append("=").append(value != null ? value : "");
    
    if (path != null) {
        header.append("; Path=").append(path);
    }
    if (domain != null) {
        header.append("; Domain=").append(domain);
    }
    if (maxAge >= 0) {
        header.append("; Max-Age=").append(maxAge);
    }
    if (httpOnly) {
        header.append("; HttpOnly");
    }
    if (secure) {
        header.append("; Secure");
    }
    if (sameSite != null) {
        header.append("; SameSite=").append(sameSite);
    }
    
    return header.toString();
}
```

---

### 문제 2: @RequestMapping 어노테이션 속성 불일치
**증상:**
- SessionController에서 `path` 속성 사용했으나 표준은 `value` 속성

**원인:**
- Spring 표준에서는 `value` 속성이 기본
- 기존 프로젝트와 일관성 부족

**해결 방법:**
```java
// Before
@RequestMapping(path = "/session", method = "GET")

// After  
@RequestMapping(value = "/session", method = "GET")
```

---

### 문제 3: ModelAndView 생성자 사용 오류
**증상:**
```
java.lang.NoSuchMethodException: ModelAndView.<init>(String, Map)
```

**원인:**
- ModelAndView는 뷰 이름만 받는 생성자만 존재
- 모델 데이터는 `addAttribute()` 메서드로 추가해야 함

**해결 방법:**
```java
// Before (잘못된 방식)
Map<String, Object> model = new HashMap<>();
model.put("key", "value");
return new ModelAndView("viewName", model);

// After (올바른 방식)
ModelAndView mv = new ModelAndView("viewName");
mv.addAttribute("key", "value");
return mv;
```

---

### 문제 4: SessionController가 HandlerMapping에 등록되지 않음
**증상:**
```
Failed to invoke handler method: HandlerMethod{path='/session/set', method='POST', handler=SessionController.setSessionAttribute()}
```

**원인:**
- CombinedHandlerMapping의 `registerAllControllers()` 메서드에 SessionController 등록 누락
- 컨트롤러가 등록되지 않아 HandlerMethod를 찾을 수 없음

**해결 방법:**
```java
// CombinedHandlerMapping.java의 registerAllControllers() 메서드에 추가
private void registerAllControllers() {
    try {
        annotationHandlerMapping.registerController(ProductController.class);
        annotationHandlerMapping.registerController(SearchController.class);
        annotationHandlerMapping.registerController(FileUploadController.class);
        
        // 25단계: 세션 관리 테스트 컨트롤러 등록
        annotationHandlerMapping.registerController(SessionController.class);
        
    } catch (Exception e) {
        System.err.println("Failed to register annotation controllers: " + e.getMessage());
    }
}
```

---

### 문제 5: @RequestParam 파라미터 바인딩 실패
**증상:**
```
Failed to invoke handler method: HandlerMethod{...}
```

**원인:**
- `@RequestParam(name = "paramName")` 사용 시 파라미터 매핑 실패
- ParameterResolver에서 `value()` 우선 확인 후 `name()` 확인하는데, `value()`가 빈 문자열이면 매핑 실패

**해결 방법:**
```java
// Before (문제 있는 코드)
@RequestParam(name = "key") String key
@RequestParam(name = "value") String value

// After (수정된 코드)
@RequestParam("key") String key
@RequestParam("value") String value
```

---

### 문제 6: SessionManager shutdown 시 중복 무효화 오류
**증상:**
```
java.lang.IllegalStateException: Session has been invalidated
```

**원인:**
- `invalidateAllSessions()`에서 이미 무효화된 세션을 다시 무효화하려고 시도
- 세션 무효화 후 다시 `invalidate()` 호출 시 예외 발생

**해결 방법:**
```java
public void invalidateAllSessions() {
    int invalidatedCount = 0;
    for (Map.Entry<String, StandardHttpSession> entry : sessions.entrySet()) {
        StandardHttpSession session = entry.getValue();
        if (session.isValid()) {
            try {
                session.invalidate();
                invalidatedCount++;
            } catch (IllegalStateException e) {
                // 이미 무효화된 세션은 무시
            }
        }
    }
    totalSessionsInvalidated += invalidatedCount;
    sessions.clear();
}
```

---

## 🔍 디버깅 팁

### 1. 핸들러 등록 확인
```java
// CombinedHandlerMapping에서 등록된 핸들러 출력
public void printRegisteredHandlers() {
    System.out.println("=== Registered Handlers ===");
    for (HandlerMethod handler : annotationHandlerMapping.getAllHandlers()) {
        System.out.println("  " + handler);
    }
}
```

### 2. 파라미터 바인딩 디버깅
```java
// ParameterResolver에서 디버깅 정보 출력
System.out.println("=== Parameter Binding Debug Info ===");
System.out.println("Method: " + method.getName() + " with " + parameters.length + " parameters");
for(int i = 0; i < parameters.length; i++){
    Parameter parameter = parameters[i];
    String strategy = parameterResolver.getResolutionStrategy(parameter);
    System.out.println("Parameter " + i + " (" + parameter.getType().getSimpleName() + "): " + strategy);
}
```

### 3. 세션 상태 모니터링
```java
// SessionManager 상태 정보 출력
System.out.println("SessionManager 상태: " + sessionManager.toString());
```

## ⚠️ 주의사항

1. **어노테이션 속성 일관성**: `@RequestMapping`과 `@RequestParam`에서 `value` 속성 사용 권장
2. **ModelAndView 사용법**: 생성자는 뷰 이름만, 모델은 `addAttribute()` 사용
3. **컨트롤러 등록**: 새로운 컨트롤러는 CombinedHandlerMapping에 등록 필요
4. **세션 무효화**: 이미 무효화된 세션에 대한 중복 처리 방지
5. **쿠키 헤더**: HTTP 표준에 맞는 Set-Cookie 헤더 문자열 생성

## 🎯 예방 방법

1. **코드 리뷰**: 어노테이션 사용법과 API 호출 방식 검토
2. **단위 테스트**: 각 컴포넌트별 독립적인 테스트 작성
3. **통합 테스트**: 전체 요청-응답 흐름 테스트
4. **로깅 강화**: 디버깅 정보 충분히 출력
5. **문서화**: API 사용법과 주의사항 문서화

이러한 문제들을 통해 Winter Framework의 세션 관리 기능이 더욱 견고해졌습니다!