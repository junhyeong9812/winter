# 🎯 Winter Framework 26챕터: View Engine Integration 구현 사항

## 📋 **구현 개요**

**26챕터**는 Winter Framework를 단순한 MVC 프레임워크에서 **다양한 뷰 엔진을 지원하는 유연한 웹 프레임워크**로 발전시키는 핵심 업데이트입니다.

---

## 🏗️ **핵심 아키텍처 변경**

### 1. **View 인터페이스 확장**
```java
// 기존 (1-25챕터)
void render(Map<String,Object> model, HttpResponse response);

// 변경 (26챕터)
void render(Map<String,Object> model, HttpRequest request, HttpResponse response);
```

**변경 이유**: 뷰 엔진에서 요청 정보(헤더, 세션 등)를 활용할 수 있도록 HttpRequest 추가

### 2. **HttpResponse Writer 지원 추가**
```java
public class HttpResponse {
    private PrintWriter writer;
    private StringWriter stringWriter;
    
    public PrintWriter getWriter();        // 새로 추가
    public void flushWriter();            // 새로 추가
    public void resetWriter();            // 새로 추가
}
```

**목적**: IntegratedView에서 스트림 방식으로 템플릿 렌더링 결과 출력

---

## 🎨 **새로운 뷰 엔진 시스템**

### 1. **ViewEngine 인터페이스**
```java
public interface ViewEngine {
    String[] getSupportedExtensions();    // 지원 확장자 반환
    String render(String templatePath, Map<String, Object> model, 
                  HttpRequest request, HttpResponse response) throws Exception;
    void initialize();                    // 엔진 초기화
    String getEngineName();              // 엔진 이름 반환
    int getPriority();                   // 우선순위 반환 (낮을수록 높은 우선순위)
}
```

### 2. **구현된 4가지 뷰 엔진**

#### 🔹 **SimpleTemplateEngine** (기본 엔진)
- **지원 확장자**: `.html`
- **문법**: `${변수명}`, `${user.name}` (점 표기법 지원)
- **기능**:
    - Reflection을 통한 중첩 객체 접근
    - getter/isXxx 메서드 자동 호출
    - null 안전 처리
- **우선순위**: 50

#### 🔹 **MockThymeleafEngine**
- **지원 확장자**: `.th`, `.thymeleaf`
- **문법**: `th:text`, `th:if`, `th:each` 속성 시뮬레이션
- **기능**:
    - 조건부 렌더링 (`th:if`)
    - 반복 처리 (`th:each`)
    - 텍스트 치환 (`th:text`)
- **우선순위**: 10

#### 🔹 **MockMustacheEngine**
- **지원 확장자**: `.mustache`
- **문법**: `{{변수}}`, `{{#section}}`, `{{^inverted}}`
- **기능**:
    - 변수 치환
    - 섹션 렌더링
    - 배열/리스트 순회
- **우선순위**: 20

#### 🔹 **MockJspEngine**
- **지원 확장자**: `.jsp`
- **문법**: `<%= 변수 %>`, `<% 코드 %>` 스크립틀릿 시뮬레이션
- **기능**:
    - 표현식 태그 처리
    - 스크립틀릿 시뮬레이션
    - JSP 내장 객체 모방
- **우선순위**: 30

### 3. **ViewEngineRegistry** (엔진 관리자)
```java
public class ViewEngineRegistry {
    private Map<String, ViewEngine> extensionEngineMap;     // 확장자별 엔진 매핑
    private List<ViewEngine> registeredEngines;            // 등록된 엔진 목록
    private ViewEngine defaultEngine;                      // 기본 엔진
    
    // 핵심 메서드
    public void registerEngine(ViewEngine engine);         // 엔진 등록
    public ViewEngine getEngineForTemplate(String path);   // 템플릿에 맞는 엔진 반환
    public void setDefaultEngine(ViewEngine engine);       // 기본 엔진 설정
}
```

**기능**:
- 우선순위 기반 엔진 선택
- 확장자별 자동 매핑
- 기본 엔진 fallback 지원

---

## 🔄 **통합 뷰 해결 시스템**

### 1. **IntegratedViewResolver**
```java
public class IntegratedViewResolver implements ViewResolver {
    private ViewEngineRegistry engineRegistry;
    private ContentNegotiatingViewResolver contentNegotiatingViewResolver;
    
    @Override
    public View resolveViewName(String viewName) {
        // 1. JSON 뷰 우선 확인 (Content Negotiation)
        // 2. 템플릿 파일 후보 검색
        // 3. 적절한 뷰 엔진 선택
        // 4. IntegratedView 생성
    }
}
```

**해결 과정**:
1. **Content Negotiation**: `Accept: application/json` → JsonView 반환
2. **템플릿 검색**: 뷰명 + 지원 확장자로 파일 탐색
3. **우선순위 정렬**: 뷰 엔진 우선순위에 따라 정렬
4. **뷰 생성**: 선택된 엔진과 템플릿으로 IntegratedView 생성
5. **Fallback**: 적절한 엔진이 없으면 에러 뷰 생성

### 2. **IntegratedView**
```java
public class IntegratedView implements View {
    private ViewEngine engine;
    private String templatePath;
    
    @Override
    public void render(Map<String, Object> model, HttpRequest request, HttpResponse response) {
        // 1. 뷰 엔진으로 템플릿 렌더링
        // 2. Writer를 통해 결과 출력
        // 3. 에러 시 사용자 친화적 에러 페이지 생성
    }
}
```

---

## 🎮 **테스트 시스템**

### 1. **ViewEngineController** (8가지 테스트)
```java
@Controller
public class ViewEngineController {
    @RequestMapping("/view/simple")     // SimpleTemplateEngine 테스트
    @RequestMapping("/view/thymeleaf")  // MockThymeleafEngine 테스트
    @RequestMapping("/view/mustache")   // MockMustacheEngine 테스트
    @RequestMapping("/view/jsp")        // MockJspEngine 테스트
    @RequestMapping("/view/priority")   // 우선순위 테스트
    @RequestMapping("/view/nonexistent") // 404 에러 테스트
    @RequestMapping("/view/performance") // 성능 비교 테스트
    @RequestMapping("/view/info")       // 엔진 정보 조회
}
```

### 2. **WinterMain 통합 테스트**
```java
private static void testViewEngineIntegration(Dispatcher dispatcher) {
    // 10개의 포괄적인 테스트 시나리오
    // 1. SimpleTemplateEngine
    // 2. MockThymeleafEngine
    // 3. MockMustacheEngine
    // 4. MockJspEngine
    // 5. 존재하지 않는 템플릿 (404)
    // 6. 뷰 엔진 우선순위
    // 7. 성능 테스트
    // 8. 엔진 정보 조회
    // 9. JSON vs HTML Content Negotiation
    // 10. 렌더링 오류 처리
}
```

---

## 📁 **파일 구조**

### **새로 생성된 파일들**
```
src/winter/view/engine/
├── ViewEngine.java                    # 뷰 엔진 인터페이스
├── ViewEngineRegistry.java           # 엔진 관리자
├── SimpleTemplateEngine.java         # 기본 템플릿 엔진
├── MockThymeleafEngine.java          # Thymeleaf 시뮬레이션
├── MockMustacheEngine.java           # Mustache 시뮬레이션
└── MockJspEngine.java                # JSP 시뮬레이션

src/winter/view/
├── IntegratedView.java               # 통합 뷰 구현체
└── IntegratedViewResolver.java       # 통합 뷰 해결자

src/winter/controller/
└── ViewEngineController.java         # 뷰 엔진 테스트 컨트롤러

src/winter/templates/
├── view-simple.html                  # SimpleTemplateEngine용
├── view-thymeleaf.th                 # MockThymeleafEngine용
├── view-mustache.mustache            # MockMustacheEngine용
└── view-jsp.jsp                      # MockJspEngine용
```

### **수정된 기존 파일들**
```
src/winter/view/
├── View.java                         # 인터페이스에 HttpRequest 추가
├── JsonView.java                     # render 메서드 시그니처 변경
├── InternalResourceView.java         # render 메서드 시그니처 변경
├── InternalResourceViewLegacy.java   # render 메서드 시그니처 변경
└── ModelAndView.java                 # 편의 생성자 추가

src/winter/http/
└── HttpResponse.java                 # getWriter() 메서드 추가

src/winter/dispatcher/
└── Dispatcher.java                   # IntegratedViewResolver 사용

src/winter/
└── WinterMain.java                   # 26챕터 테스트 추가
```

---

## 🔧 **업데이트된 기능들**

### 1. **ModelAndView 개선**
```java
// 기존 방식 (1-25챕터)
ModelAndView mv = new ModelAndView("products");
mv.addAttribute("title", "상품 목록");
mv.addAttribute("products", productList);

// 새로운 방식 (26챕터)
Map<String, Object> model = new HashMap<>();
model.put("title", "상품 목록");
model.put("products", productList);
ModelAndView mv = new ModelAndView("products", model);

// 혼합 사용
ModelAndView mv = new ModelAndView("products", baseModel);
mv.addAttribute("timestamp", System.currentTimeMillis());
```

### 2. **Dispatcher 업데이트**
```java
// 기존: ContentNegotiatingViewResolver 사용
ContentNegotiatingViewResolver viewResolver = new ContentNegotiatingViewResolver();

// 변경: IntegratedViewResolver 사용
IntegratedViewResolver viewResolver = new IntegratedViewResolver();
viewResolver.setCurrentRequest(request);
View view = viewResolver.resolveViewName(mv.getViewName());
view.render(mv.getModel(), request, response); // HttpRequest 추가
```

---

## 🎯 **핵심 알고리즘**

### 1. **뷰 엔진 선택 알고리즘**
```
1. 뷰명에서 템플릿 파일 후보들 검색
   - 예: "view-simple" → ["view-simple.html", "view-simple.th", ...]

2. 존재하는 파일들만 필터링
   - 실제 파일 시스템에서 존재 여부 확인

3. 우선순위에 따라 정렬
   - MockThymeleafEngine (10) > MockMustacheEngine (20) > MockJspEngine (30) > SimpleTemplateEngine (50)

4. 첫 번째 파일의 엔진 선택
   - 가장 높은 우선순위의 엔진 사용

5. IntegratedView 생성
   - 선택된 엔진과 템플릿 경로로 뷰 객체 생성
```

### 2. **Content Negotiation 알고리즘**
```
1. Accept 헤더 확인
   - "application/json" → JsonView 반환
   - "text/html" 또는 없음 → 템플릿 뷰 처리

2. 템플릿 뷰 해결
   - 뷰 엔진 선택 알고리즘 실행

3. 결과 반환
   - JsonView 또는 IntegratedView
```

---

## 📊 **성능 특성**

### 1. **뷰 엔진별 성능**
- **SimpleTemplateEngine**: 가장 빠름 (정규식 + Reflection)
- **MockThymeleafEngine**: 중간 (XML 파싱 시뮬레이션)
- **MockMustacheEngine**: 중간 (템플릿 파싱)
- **MockJspEngine**: 느림 (복잡한 스크립틀릿 처리)

### 2. **최적화 요소**
- **확장자 맵 캐싱**: O(1) 엔진 검색
- **우선순위 정렬**: 한 번만 수행
- **템플릿 파일 존재 확인**: 파일 시스템 접근 최소화
- **에러 뷰 캐싱**: 반복적인 에러 페이지 생성 방지

---

## 🚀 **확장 가능성**

### 1. **새로운 뷰 엔진 추가**
```java
// 새로운 뷰 엔진 구현
public class ReactServerSideEngine implements ViewEngine {
    @Override
    public String[] getSupportedExtensions() {
        return new String[]{"jsx", "tsx"};
    }
    
    @Override
    public String render(String templatePath, Map<String, Object> model, 
                        HttpRequest request, HttpResponse response) throws Exception {
        // React Server Side Rendering 로직
    }
}

// 등록
viewEngineRegistry.registerEngine(new ReactServerSideEngine());
```

### 2. **실제 라이브러리 통합**
```java
// 실제 Thymeleaf 엔진
public class RealThymeleafEngine implements ViewEngine {
    private TemplateEngine templateEngine;
    
    @Override
    public void initialize() {
        this.templateEngine = new TemplateEngine();
        // Thymeleaf 설정
    }
    
    @Override
    public String render(String templatePath, Map<String, Object> model, 
                        HttpRequest request, HttpResponse response) throws Exception {
        Context context = new Context();
        context.setVariables(model);
        return templateEngine.process(templatePath, context);
    }
}
```

---

## 🎉 **26챕터의 의의**

### 1. **아키텍처 진화**
- **단일 책임 원칙**: 각 뷰 엔진이 특정 템플릿 형식만 담당
- **개방-폐쇄 원칙**: 새로운 뷰 엔진 추가 시 기존 코드 수정 불필요
- **의존성 역전 원칙**: ViewEngine 인터페이스에 의존

### 2. **실무 연관성**
- **Spring Boot**: 실제로 여러 뷰 엔진 지원 (Thymeleaf, Mustache, JSP)
- **마이크로서비스**: 서비스별로 다른 뷰 기술 선택 가능
- **레거시 마이그레이션**: 점진적 뷰 기술 전환 지원

### 3. **학습 효과**
- **디자인 패턴**: Strategy, Factory, Registry 패턴 학습
- **플러그인 아키텍처**: 확장 가능한 시스템 설계
- **템플릿 엔진**: 다양한 템플릿 기술의 특성 이해

---

